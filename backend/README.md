# Shoes API Backend

A clean architecture Node.js + Express API with TypeScript, featuring:

- **TSOA** for clean route generation and OpenAPI documentation
- **Prisma** ORM with SQLite database
- **tsyringe** for IoC and Dependency Injection
- **class-validator** for request body validation
- **Repository Pattern** with generic base repository

## Project Structure

```
backend/
├── prisma/
│   └── schema.prisma              # Database schema
├── src/
│   ├── constants/                 # Shared constants
│   │   ├── auth.constants.ts      # JWT & password config
│   │   ├── validation.constants.ts # Validation messages
│   │   └── index.ts
│   ├── container/                 # IoC container configuration
│   │   ├── index.ts               # DI registration
│   │   └── ioc.ts                 # TSOA adapter
│   ├── controllers/               # TSOA controllers (HTTP layer)
│   │   ├── AuthController.ts
│   │   ├── ShoeController.ts
│   │   └── index.ts
│   ├── database/                  # Database configuration
│   │   └── prisma.ts
│   ├── dto/                       # Data Transfer Objects with validation
│   │   ├── auth.dto.ts            # Login & Register DTOs
│   │   ├── shoe.dto.ts            # Shoe DTOs
│   │   └── index.ts
│   ├── generated/                 # Auto-generated by TSOA
│   │   ├── routes.ts
│   │   └── swagger.json
│   ├── interfaces/                # All interfaces
│   │   ├── repository/            # Repository interfaces
│   │   │   ├── IBaseRepository.ts
│   │   │   ├── IShoeRepository.ts
│   │   │   ├── IUserRepository.ts
│   │   │   └── index.ts
│   │   ├── service/               # Service interfaces
│   │   │   ├── IAuthService.ts
│   │   │   ├── IShoeService.ts
│   │   │   └── index.ts
│   │   └── index.ts
│   ├── middleware/                # Express middleware
│   │   ├── authentication.ts      # JWT auth for TSOA
│   │   ├── validation.ts          # class-validator helper
│   │   └── index.ts
│   ├── repositories/              # Data access layer
│   │   ├── base/
│   │   │   ├── BaseRepository.ts  # Generic base repository
│   │   │   └── index.ts
│   │   ├── ShoeRepository.ts
│   │   ├── UserRepository.ts
│   │   └── index.ts
│   ├── services/                  # Business logic layer
│   │   ├── AuthService.ts
│   │   ├── ShoeService.ts
│   │   └── index.ts
│   ├── types/                     # TypeScript types
│   │   ├── entities/              # Entity types
│   │   │   ├── Shoe.ts
│   │   │   ├── User.ts
│   │   │   └── index.ts
│   │   ├── responses/             # Response types
│   │   │   ├── AuthResponse.ts
│   │   │   ├── ErrorResponse.ts
│   │   │   ├── ShoeResponse.ts
│   │   │   └── index.ts
│   │   └── index.ts
│   ├── app.ts                     # Express app configuration
│   └── server.ts                  # Server entry point
├── package.json
├── tsconfig.json
└── tsoa.json
```

## Getting Started

### Prerequisites

- Node.js 18+
- npm or yarn

### Installation

1. Install dependencies:
   ```bash
   cd backend
   npm install
   ```

2. Create `.env` file from example:
   ```bash
   cp env.example .env
   ```
   
   Or create manually with:
   ```
   DATABASE_URL="file:./dev.db"
   PORT=3000
   JWT_SECRET=your-super-secret-jwt-key-change-in-production
   CORS_ORIGINS=http://localhost:5173
   ```

3. Generate Prisma client and run migrations:
   ```bash
   npm run prisma:generate
   npm run prisma:migrate
   ```

4. Generate TSOA routes:
   ```bash
   npm run tsoa:generate
   ```

5. Start the development server:
   ```bash
   npm run dev
   ```

## Environment Variables

| Variable         | Description                              | Default                   |
|------------------|------------------------------------------|---------------------------|
| DATABASE_URL     | SQLite database path                     | file:./dev.db             |
| PORT             | Server port                              | 3000                      |
| JWT_SECRET       | Secret key for JWT tokens                | (change in production!)   |
| CORS_ORIGINS     | Allowed CORS origins (comma-separated)   | http://localhost:5173     |
| CORS_CREDENTIALS | Allow credentials in CORS                | true                      |
| FRONTEND_URL     | (Deprecated) Use CORS_ORIGINS instead    | http://localhost:5173     |

### CORS Configuration Examples

**Single origin:**
```
CORS_ORIGINS=http://localhost:5173
```

**Multiple origins:**
```
CORS_ORIGINS=http://localhost:5173,http://localhost:3000,https://myapp.com
```

**Production example:**
```
CORS_ORIGINS=https://myapp.com,https://www.myapp.com,https://admin.myapp.com
```

## API Endpoints

### Authentication (Public)

| Method | Endpoint           | Description               |
|--------|-------------------|---------------------------|
| POST   | /api/auth/register | Register a new user       |
| POST   | /api/auth/login    | Login and get JWT token   |
| GET    | /api/auth/me       | Get current user (auth)   |

### Shoes (Protected - Requires JWT)

| Method | Endpoint          | Description          |
|--------|-------------------|----------------------|
| GET    | /api/shoes        | Get all shoes        |
| POST   | /api/shoes        | Create a new shoe    |
| DELETE | /api/shoes/:id    | Delete a shoe by ID  |

**Note:** All shoe endpoints require a valid JWT token in the Authorization header:
```
Authorization: Bearer <your-jwt-token>
```

## API Documentation

Once the server is running, access the Swagger UI at:
```
http://localhost:3000/api/docs
```

## Scripts

| Script              | Description                           |
|---------------------|---------------------------------------|
| `npm run dev`       | Start development server with hot reload |
| `npm run build`     | Build for production                  |
| `npm start`         | Start production server               |
| `npm run tsoa:generate` | Generate TSOA routes and spec     |
| `npm run prisma:generate` | Generate Prisma client           |
| `npm run prisma:migrate`  | Run database migrations          |
| `npm run prisma:studio`   | Open Prisma Studio               |
| `npm run prisma:seed`     | Seed database with default data  |

## Database Seeding

The project includes a seed script to populate the database with initial data.

### Default User

| Field    | Value              |
|----------|-------------------|
| Email    | admin@example.com |
| Password | Abc@123           |
| Name     | Admin User        |

### Sample Shoes

- Air Jordan 1 (Nike)
- Yeezy Boost 350 (Adidas)
- Chuck Taylor All Star (Converse)

### Running the Seed

```bash
# Using npm
npm run prisma:seed

# Using pnpm (from root)
pnpm run db:seed
```

### Customizing the Seed

Edit `prisma/seed.ts` to add or modify seed data:

```typescript
// Add more users
const newUser = await prisma.user.upsert({
  where: { email: "user@example.com" },
  update: {},
  create: {
    email: "user@example.com",
    password: await bcrypt.hash("password123", 10),
    name: "New User",
  },
});
```

## Architecture

### Base Repository Pattern

The project uses a generic `BaseRepository<T, CreateDTO>` that provides:
- `findAll()` - Get all entities
- `findById(id)` - Find by ID
- `create(data)` - Create new entity
- `update(id, data)` - Update entity
- `delete(id)` - Delete entity

Specific repositories extend this base and add domain-specific methods:

```typescript
class ShoeRepository extends BaseRepository<Shoe, CreateShoeData> {
  findByBrand(brand: string): Promise<Shoe[]>
}
```

### Request Validation

The project uses **class-validator** for DTO validation:

```typescript
class CreateShoeDTO {
  @IsString()
  @IsNotEmpty({ message: "Shoe name is required" })
  @MinLength(2)
  name!: string;
}
```

### Dependency Injection

The project uses **tsyringe** for dependency injection:

- Interfaces are registered with their implementations in `src/container/index.ts`
- Controllers receive dependencies via constructor injection
- Services receive repositories via constructor injection

### Folder Organization

| Folder        | Purpose                                        |
|---------------|------------------------------------------------|
| `constants/`  | Shared configuration and message constants     |
| `dto/`        | DTOs with class-validator decorators           |
| `interfaces/` | All interface definitions                       |
| `types/`      | TypeScript type definitions                    |
| `middleware/` | Express middleware (auth, validation)          |
| `repositories/` | Data access with base repository pattern     |
| `services/`   | Business logic layer                           |
| `controllers/` | HTTP handlers with TSOA decorators            |

### Clean Separation of Concerns

1. **Controllers**: Handle HTTP requests/responses, use DTOs for validation
2. **Services**: Business logic and orchestration
3. **Repositories**: Data access with generic base operations
4. **DTOs**: Request validation with class-validator
5. **Types**: Domain entities and response types
